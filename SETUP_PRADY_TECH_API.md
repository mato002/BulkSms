# Setup Guide: PRADY_TECH API Integration

## Overview

This guide will help you set up API access for PRADY_TECH so they can send SMS through your platform instead of calling Onfon directly.

## Problem Statement

Currently, PRADY_TECH is calling the Onfon API directly using the main account credentials. This approach has several issues:
- ❌ Security risk (sharing main credentials)
- ❌ No usage tracking per sender
- ❌ No billing control
- ❌ No rate limiting per sender

## Solution

Create a dedicated API for PRADY_TECH with:
- ✅ Unique API key for authentication
- ✅ Individual balance tracking
- ✅ Usage statistics and history
- ✅ Proper billing and cost management
- ✅ Rate limiting based on tier

---

## Step 1: Generate API Credentials

Run the credentials generator script:

```bash
php generate_api_credentials.php
```

This script will:
1. Find or create the PRADY_TECH client in the database
2. Generate a unique API key
3. Configure the SMS channel with Onfon integration
4. Display all API endpoints and credentials
5. Create a Postman collection for testing
6. Save credentials to `PRADY_TECH_API_CREDENTIALS.txt`

**Expected Output:**
```
=================================================
    API CREDENTIALS FOR: Prady Technologies
=================================================

Client ID:      1
Sender ID:      PRADY_TECH
API Key:        xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx

=================================================
    ENDPOINTS
=================================================

Base URL: http://localhost

1. Send SMS:
   POST http://localhost/api/1/messages/send
   
2. Check Balance:
   GET http://localhost/api/1/client/balance
```

---

## Step 2: Add Balance to the Account

PRADY_TECH needs balance to send SMS. You can add balance in two ways:

### Option A: Using the Admin Dashboard
1. Log in as admin
2. Navigate to Clients → PRADY_TECH
3. Click "Add Balance"
4. Enter amount in KSH
5. Save

### Option B: Using Database (Temporary for Testing)
```sql
UPDATE clients 
SET balance = 1000.00, 
    price_per_unit = 1.00 
WHERE sender_id = 'PRADY_TECH';
```

This gives PRADY_TECH:
- **Balance:** KSH 1,000.00
- **Units:** 1,000 SMS (at KSH 1.00 per unit)

---

## Step 3: Test the API

Run the test script:

```bash
php test_sender_api.php
```

This will run 7 tests:
1. ✅ API Health Check
2. ✅ API Authentication
3. ✅ Check Balance
4. ✅ Send Test SMS (optional)
5. ✅ SMS History
6. ✅ SMS Statistics
7. ✅ Invalid API Key (Security Test)

**Sample Output:**
```
=================================================
    SENDER API TEST - PRADY_TECH
=================================================

✅ Found client: Prady Technologies
   Client ID: 1
   API Key: xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
   Balance: KSH 1,000.00
   Units: 1,000.00

=================================================
TEST 1: API Health Check
=================================================

✅ API is running
```

---

## Step 4: Share Credentials with PRADY_TECH

### What to Share:
1. **API Key** - Keep this secret!
2. **Client ID** - Their unique identifier
3. **Base URL** - Your API endpoint
4. **Documentation** - `SENDER_API_DOCUMENTATION.md`

### How to Share Securely:
- ✅ Use encrypted email
- ✅ Password-protected document
- ✅ Secure file sharing service
- ❌ Never share via plain SMS or unencrypted email

### Files to Send:
```
PRADY_TECH_API_CREDENTIALS.txt  (Generated by script)
SENDER_API_DOCUMENTATION.md      (Complete API docs)
```

---

## API Usage Examples

### Example 1: Send SMS (cURL)

```bash
curl -X POST http://localhost/api/1/messages/send \
  -H "X-API-Key: your_api_key_here" \
  -H "Content-Type: application/json" \
  -d '{
    "channel": "sms",
    "recipient": "254712345678",
    "body": "Hello from PRADY_TECH!",
    "sender": "PRADY_TECH"
  }'
```

### Example 2: Check Balance (cURL)

```bash
curl -X GET http://localhost/api/1/client/balance \
  -H "X-API-Key: your_api_key_here"
```

### Example 3: Send SMS (PHP)

```php
<?php

$apiKey = 'your_api_key_here';
$clientId = 1;

$ch = curl_init("http://localhost/api/{$clientId}/messages/send");
curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
curl_setopt($ch, CURLOPT_POST, true);
curl_setopt($ch, CURLOPT_HTTPHEADER, [
    'X-API-Key: ' . $apiKey,
    'Content-Type: application/json',
]);
curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode([
    'channel' => 'sms',
    'recipient' => '254712345678',
    'body' => 'Test message',
    'sender' => 'PRADY_TECH',
]));

$response = curl_exec($ch);
$httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
curl_close($ch);

if ($httpCode === 200) {
    echo "✅ Message sent!\n";
    print_r(json_decode($response, true));
} else {
    echo "❌ Error: {$response}\n";
}
```

---

## How It Works

### Request Flow:

```
PRADY_TECH App
    ↓
[1] POST /api/1/messages/send
    (with X-API-Key header)
    ↓
[2] ApiAuth Middleware
    (validates API key)
    ↓
[3] CompanyAuth Middleware
    (verifies client_id matches)
    ↓
[4] MessageController
    (validates request)
    ↓
[5] MessageDispatcher
    (gets channel config)
    ↓
[6] OnfonSmsSender
    (sends to Onfon API)
    ↓
[7] Response to PRADY_TECH
    (success or error)
```

### Key Components:

1. **ApiAuth Middleware** (`app/Http/Middleware/ApiAuth.php`)
   - Validates API key from header
   - Loads client from database
   - Rejects invalid keys

2. **CompanyAuth Middleware** (`app/Http/Middleware/CompanyAuth.php`)
   - Ensures client can only access their own data
   - Prevents unauthorized access

3. **MessageController** (`app/Http/Controllers/Api/MessageController.php`)
   - Validates request parameters
   - Checks balance
   - Queues message for sending

4. **OnfonSmsSender** (`app/Services/Messaging/Drivers/Sms/OnfonSmsSender.php`)
   - Sends SMS via Onfon API
   - Uses credentials from channel configuration
   - Returns message ID or error

---

## Channel Configuration

Each client has their own channel configuration. For PRADY_TECH:

```json
{
    "client_id": 1,
    "name": "sms",
    "provider": "onfon",
    "credentials": {
        "api_key": "VKft5j+GOeSXYSlk+sADT/nx5UMVpcmengSPk9Ou4Ak=",
        "client_id": "e27847c1-a9fe-4eef-b60d-ddb291b175ab",
        "access_key_header": "8oj1kheKHtCX6RiiOOI1sNS9Ir88CXnB",
        "default_sender": "PRADY_TECH"
    },
    "active": true
}
```

This configuration:
- Uses the main Onfon account credentials
- Routes all PRADY_TECH SMS through our platform
- Allows tracking and billing
- Can be changed without affecting PRADY_TECH's integration

---

## Monitoring and Management

### View Usage Statistics

```bash
curl -X GET "http://localhost/api/1/sms/statistics?period=month" \
  -H "X-API-Key: your_api_key_here"
```

### View SMS History

```bash
curl -X GET "http://localhost/api/1/sms/history?page=1&per_page=50" \
  -H "X-API-Key: your_api_key_here"
```

### Check Delivery Status

The system automatically tracks:
- ✅ Messages sent
- ✅ Messages delivered
- ✅ Failed messages
- ✅ Cost per message
- ✅ Delivery time

---

## Billing and Costs

### How Billing Works:

1. **Price Per Unit** - Set in client configuration (e.g., KSH 1.00)
2. **Balance** - Total available balance in KSH
3. **Units** - Balance ÷ Price Per Unit (e.g., 1000 KSH ÷ 1.00 = 1000 units)
4. **Deduction** - Each SMS deducts units based on message length

### Message Length Costing:

| Length | Units | Cost (@ KSH 1.00/unit) |
|--------|-------|------------------------|
| 1-160 chars | 1 | KSH 1.00 |
| 161-320 chars | 2 | KSH 2.00 |
| 321-480 chars | 3 | KSH 3.00 |

### Top-Up Options:

1. **M-Pesa** - Automated top-up via STK Push
2. **Manual** - Admin adds balance
3. **Wallet Sync** - Sync from Onfon wallet (if enabled)

---

## Security Best Practices

### For You (Admin):
- ✅ Rotate API keys regularly
- ✅ Monitor unusual usage patterns
- ✅ Set balance alerts
- ✅ Use HTTPS in production
- ✅ Enable rate limiting

### For PRADY_TECH:
- ✅ Store API key securely (environment variables)
- ✅ Never commit API key to version control
- ✅ Use HTTPS for all requests
- ✅ Implement error handling
- ✅ Monitor balance regularly

---

## Troubleshooting

### Issue: Script doesn't generate credentials

**Solution:**
```bash
# Check database connection
php artisan db:show

# Run migrations if needed
php artisan migrate

# Run seeder
php artisan db:seed --class=ClientsSeeder
php artisan db:seed --class=ChannelsSeeder

# Try again
php generate_api_credentials.php
```

### Issue: API returns 401 Unauthorized

**Check:**
- ✅ API key is correct
- ✅ Header name is `X-API-Key` (case-sensitive)
- ✅ Client status is active
- ✅ Client ID in URL matches API key owner

### Issue: API returns "Insufficient balance"

**Solution:**
```sql
-- Add balance to client
UPDATE clients 
SET balance = 1000.00 
WHERE sender_id = 'PRADY_TECH';
```

### Issue: SMS not sending

**Check:**
- ✅ Channel is configured and active
- ✅ Onfon credentials are correct
- ✅ Sender ID is approved by Onfon
- ✅ Recipient number format (254...)
- ✅ Server can reach Onfon API

---

## Testing Checklist

Before going live, test:

- [ ] Generate credentials successfully
- [ ] API authentication works
- [ ] Balance checking works
- [ ] Send test SMS successfully
- [ ] SMS is delivered
- [ ] Balance is deducted correctly
- [ ] History shows sent messages
- [ ] Statistics are accurate
- [ ] Invalid API key is rejected
- [ ] Rate limiting works (if enabled)

---

## Production Deployment

### Before Going Live:

1. **Update Base URL** in `.env`:
```env
APP_URL=https://your-production-domain.com
```

2. **Enable HTTPS** - SSL certificate required

3. **Configure Rate Limiting** in `config/rateLimiter.php`

4. **Set Up Monitoring** - Track API usage and errors

5. **Create Backup** - Database and configurations

6. **Test in Staging** - Verify everything works

7. **Update Documentation** - Production URLs and endpoints

### Post-Deployment:

1. Share production credentials with PRADY_TECH
2. Monitor first 100 messages closely
3. Set up alerts for:
   - Low balance
   - High failure rate
   - Unusual usage patterns

---

## Support and Maintenance

### Regular Tasks:
- Check balance weekly
- Review usage statistics monthly
- Rotate API keys quarterly
- Update documentation as needed

### Emergency Contacts:
- Admin: your-email@example.com
- PRADY_TECH: their-email@example.com
- Onfon Support: support@onfonmedia.co.ke

---

## Files Reference

| File | Purpose |
|------|---------|
| `generate_api_credentials.php` | Generate/retrieve API credentials |
| `test_sender_api.php` | Test all API endpoints |
| `SENDER_API_DOCUMENTATION.md` | Complete API documentation |
| `PRADY_TECH_API_CREDENTIALS.txt` | Generated credentials file |
| `routes/api.php` | API route definitions |
| `app/Http/Middleware/ApiAuth.php` | API authentication |
| `app/Services/Messaging/Drivers/Sms/OnfonSmsSender.php` | Onfon integration |

---

## Next Steps

1. **Run:** `php generate_api_credentials.php`
2. **Add Balance:** Update client balance
3. **Test:** `php test_sender_api.php`
4. **Share:** Send credentials to PRADY_TECH
5. **Monitor:** Watch usage and delivery rates

---

## Success Criteria

You'll know it's working when:
- ✅ PRADY_TECH can send SMS using their API key
- ✅ Messages are delivered successfully
- ✅ Balance is deducted correctly
- ✅ Usage is tracked in history
- ✅ Statistics are accurate
- ✅ PRADY_TECH is no longer using Onfon directly

---

**Last Updated:** October 9, 2025  
**Version:** 1.0.0

