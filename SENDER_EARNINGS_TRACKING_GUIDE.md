# Sender Earnings Tracking Guide

## Overview

This guide explains how to use the new **Sender-Based Message Categorization and Earnings Tracking** feature in your BulkSMS application. This feature allows you to track messages and earnings by different senders, making it easier to understand your revenue streams and message performance.

## What's New?

### 1. **Enhanced Message Model**
- Added relationships to Client and Template models
- New helper methods for filtering by sender
- Cost tracking and formatting capabilities
- Status checking methods

### 2. **All Messages View with Sender Analytics**
- Comprehensive message listing with sender information
- Real-time statistics dashboard
- Sender performance breakdown
- Earnings tracking per sender
- Advanced filtering options

### 3. **Filter Options**
- Filter by sender name
- Filter by channel (SMS, WhatsApp, Email)
- Filter by message status
- Date range filtering
- Search by recipient, body, or sender

## How to Access

### From Conversations Page
1. Go to **Messages** in the sidebar
2. Click the **"All Messages & Earnings"** button at the top right
3. You'll be redirected to the detailed messages view

### Direct Access
Navigate to: `/messages-all`

## Features Breakdown

### üìä Statistics Dashboard

At the top of the page, you'll see 5 key metrics:

1. **Total Messages**: Count of all messages matching your filters
2. **Sent**: Successfully sent/delivered messages
3. **Failed**: Messages that failed to send
4. **Pending**: Messages queued or currently sending
5. **Total Earnings**: Sum of costs from all successful messages (highlighted in gold)

### üéØ Sender Performance Cards

Each sender gets a dedicated performance card showing:

- **Sender Name**: Displayed prominently in a badge
- **Total Earnings**: Revenue generated by this sender (in KSH)
- **Statistics**:
  - **Total**: All messages from this sender
  - **Success**: Successfully delivered messages
  - **Failed**: Failed message count
  - **Success Rate**: Percentage of successful deliveries
- **View Messages Button**: Click to filter messages by that specific sender

### üîç Advanced Filtering

Filter your messages using multiple criteria:

1. **Search**: Search by recipient, message body, or sender name
2. **Sender**: Select a specific sender from dropdown
3. **Channel**: Filter by SMS, WhatsApp, or Email
4. **Status**: Filter by sent, delivered, failed, queued, or sending
5. **Date Range**: Set date from and date to

Click **"Apply Filters"** to apply your selections or **"Clear All"** to reset.

### üìã Messages Table

The table displays:

- **ID**: Message identifier
- **Sender**: The sender name (highlighted in a badge)
- **Recipient**: Phone number or email of recipient
- **Channel**: Communication channel used
- **Message**: Preview of the message body (first 50 characters)
- **Status**: Current message status with icon
- **Cost**: Cost of the message (only for successful messages)
- **Sent At**: Timestamp when message was sent

## Understanding Earnings

### How Earnings are Calculated

Earnings are calculated based on:
- Only **successful messages** (sent or delivered status)
- The `cost` field in the messages table
- Costs are stored in KSH (Kenyan Shillings)

### Earnings Per Sender

Each sender's earnings are calculated independently:
```
Sender Earnings = SUM(cost) WHERE status IN ('sent', 'delivered') AND sender = 'SENDER_NAME'
```

### Total Earnings

Total earnings shown in the statistics card:
```
Total Earnings = SUM(cost) WHERE status IN ('sent', 'delivered')
```

This respects any active filters, so if you filter by:
- **Date range**: Shows earnings for that period
- **Specific sender**: Shows only that sender's earnings
- **Channel**: Shows earnings from that channel only

## Use Cases

### 1. Track Performance by Sender
**Scenario**: You have multiple sender IDs for different purposes (marketing, notifications, etc.)

**Solution**: 
1. Go to All Messages & Earnings page
2. View the Sender Performance section
3. Compare success rates and earnings across senders
4. Click "View Messages" on any sender to drill down

### 2. Calculate Monthly Revenue
**Scenario**: You need to know how much you earned this month

**Solution**:
1. Go to All Messages & Earnings page
2. Set "Date From" to first day of month
3. Set "Date To" to last day of month (or today)
4. Click "Apply Filters"
5. Check the "Total Earnings" card

### 3. Identify Problematic Senders
**Scenario**: You want to find senders with low success rates

**Solution**:
1. Go to All Messages & Earnings page
2. Look at the Sender Performance cards
3. Identify senders with high failed message counts
4. Click "View Messages" to see failed messages
5. Add filter: Status = "Failed"

### 4. Track Specific Campaign Performance
**Scenario**: You sent a campaign using a specific sender and want to track its performance

**Solution**:
1. Go to All Messages & Earnings page
2. Select the sender from the dropdown
3. Set the date range for the campaign period
4. Review statistics and earnings

### 5. Export Data for Accounting
**Scenario**: You need earnings data for financial reporting

**Solution**:
1. Apply desired filters (date range, sender, etc.)
2. Note the statistics shown
3. Review the messages table for detailed breakdown
4. Use the data to create financial reports

## Technical Details

### Database Structure

The messages table includes these key fields for tracking:
- `sender`: The sender name/ID
- `cost`: Cost per message (decimal, 4 decimal places)
- `status`: Message status (queued, sending, sent, delivered, failed)
- `channel`: Communication channel (sms, whatsapp, email)
- `created_at`: When message was created
- `sent_at`: When message was sent
- `delivered_at`: When message was delivered

### API Integration

If you're using the API to send messages, ensure you're populating:
- `sender`: Your sender ID or name
- `cost`: The cost of sending (calculated automatically by the system)

The system automatically tracks costs based on your client's `price_per_unit` setting.

## Best Practices

### 1. Use Descriptive Sender Names
Use clear, descriptive sender names that indicate the purpose:
- ‚úÖ `ACME-Marketing`
- ‚úÖ `ACME-Notifications`
- ‚úÖ `ACME-OTP`
- ‚ùå `Sender1`, `Test`, `Default`

### 2. Regular Monitoring
- Check sender performance weekly
- Monitor success rates
- Investigate senders with high failure rates
- Track earnings trends over time

### 3. Cost Optimization
- Compare costs across different channels
- Identify which senders provide best ROI
- Optimize sender usage based on performance

### 4. Date Range Analysis
- Compare week-over-week performance
- Analyze monthly trends
- Identify seasonal patterns

## Troubleshooting

### Issue: No Senders Showing in Filter
**Cause**: No messages have been sent yet, or all messages have NULL sender
**Solution**: Send messages with proper sender IDs set

### Issue: Total Earnings Shows 0
**Cause**: No successful messages, or costs not set properly
**Solution**: 
- Check that messages have 'sent' or 'delivered' status
- Verify that cost field is populated
- Check your client's price_per_unit setting

### Issue: Sender Analytics Cards Not Appearing
**Cause**: No messages with sender IDs in database
**Solution**: Ensure messages are being sent with sender field populated

### Issue: Filters Not Working
**Cause**: Browser cache or incorrect filter values
**Solution**: 
- Clear filters and try again
- Check that date ranges are valid (From date <= To date)
- Ensure sender names match exactly (case-sensitive)

## Related Documentation

- [HOW_FORTRESS_SENDER_WORKS.md](HOW_FORTRESS_SENDER_WORKS.md) - Understanding sender management
- [SENDER_MANAGEMENT_GUIDE.md](SENDER_MANAGEMENT_GUIDE.md) - Managing sender IDs
- [SENDER_API_DOCUMENTATION.md](SENDER_API_DOCUMENTATION.md) - API integration for senders
- [SYSTEM_ARCHITECTURE_GUIDE.md](SYSTEM_ARCHITECTURE_GUIDE.md) - Overall system architecture

## Support

If you need help with sender earnings tracking:
1. Check this guide first
2. Review related documentation
3. Check your database for message records
4. Verify sender IDs are being set correctly
5. Contact support with specific details about your issue

---

**Version**: 1.0  
**Last Updated**: October 2025  
**Feature Status**: ‚úÖ Production Ready

